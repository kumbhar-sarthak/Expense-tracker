<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Expense Tracker Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" />
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
</head>

<body class="bg-gray-100 min-h-screen relative text-black">

  <div class="bg-white p-6 flex justify-between items-center flex-wrap shadow">
    <div>
      <h1 class="text-3xl font-bold">Hello, {{.Name}}</h1>
      <p class="text-gray-500 text-sm">{{.Email}}</p>
    </div>
    <div class="flex items-center gap-4 mt-4 md:mt-0">
      <img src="{{.Picture}}" alt="Profile" class="w-10 h-10 rounded-full object-cover border" />
      <a href="/logout" class="text-red-600 font-semibold hover:underline">Logout</a>
    </div>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 p-6">
    <div class="bg-white p-4 rounded-lg border flex justify-between items-center">
      <h3 class="text-xl text-gray-600 font-medium">Total Expense:</h3>
      <p class="text-red-500 text-2xl font-bold">
        ₹ {{ .Total }}
      </p>
    </div>
  </div>

  <div id="inputBar"
    class="fixed bottom-2 left-[10%] w-[80%] bg-[#8D0B41] border-t p-4 flex flex-wrap justify-evenly gap-2 items-center z-50 rounded-lg">
    <input id="desc" class="h-full text-black outline-none border-none p-4 w-1/3 rounded-lg bg-[#FFF8E6]"
      placeholder="Expense description..." />
    <input id="amount" type="number" placeholder="Amount"
      class="h-full p-4 rounded-lg shadow text-sm w-40 outline-none border-none bg-[#FFF8E6]" />
    <input id="category" type="text" placeholder="Category"
      class="h-full p-4 rounded-lg shadow text-sm w-40 outline-none border-none bg-[#FFF8E6]" />
    <input id="ptype" type="text" placeholder="Payment Type"
      class="h-full p-4 rounded-lg shadow text-sm w-40 outline-none border-none bg-[#FFF8E6]" />
    <button onclick="addExpense()"
      class="bg-[#D39D55] text-black w-10 h-10 rounded-full text-xl flex items-center justify-center hover:bg-gray-800">+</button>
  </div>

  <div class="px-6 mb-28 overflow-x-auto">
    <table id="expenseTable" class="display w-full">
      <thead>
        <tr>
          <th>SR</th>
          <th>Description</th>
          <th>Amount</th>
          <th>Category</th>
          <th>Payment Type</th>
          <th>Delete</th>
        </tr>
      </thead>
      <tbody>
        {{ range $index, $e := .Expenses }}
        <tr>
          <td>{{ add $index 1 }}</td>
          <td>{{ $e.Description }}</td>
          <td>₹ {{ $e.Amount }}</td>
          <td>{{ $e.Category }}</td>
          <td>{{ $e.Ptype }}</td>
          <td>
            <form method="POST" action="/delete/{{ $e.ID }}">
              {{ $.CSRFToken }}
              <button type="submit" class="text-red-600 hover:underline"
                onclick="return confirm('Delete this item?')">Delete</button>
            </form>
          </td>
        </tr>
        {{ end }}
      </tbody>
    </table>
  </div>

  <script>
    $(document).ready(function () {
      $('#expenseTable').DataTable();
    });

    async function addExpense() {
      const desc = $("#desc").val().trim();
      const amount = $("#amount").val().trim();
      const category = $("#category").val().trim();
      const ptype = $("#ptype").val().trim();

      if (!desc || !amount || !category || !ptype) {
        alert("All fields are required.");
        return;
      }

      const res = await fetch("/addData", {
        method: "POST",
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          Description: desc,
          Amount: amount,
          Category: category,
          Ptype: ptype
        })
      })

      if (res.ok) {
        window.location.reload();
      } else {
        const errorText = await res.text();
        console.error("Failed to add expense:", errorText);
        alert("Failed to add expense. Try again.");
      }

    }
  </script>

</body>

</html>